<!DOCTYPE html>
<html>

<head>
	<title>SDCSA - Camden Tree Analysis</title>
	<link rel="stylesheet" href="./CSS/styles.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<title>Treeconomic Output</title>
</head>

<body>

	<nav class="navbar navbar-expand-md navbar-light bg-light">
		<a class="navbar-brand" href="#">
			<h1><b>Tree Maput</b></h1>
		</a>

		<!--alows the links to shrink into a menu on small screens -->

		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
			aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item">
					<a class="nav-link" href="./index.html">Home <span class="sr-only">(current)</span></a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="./about.html">About</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="./group.html">Group</a>
				</li>
			</ul>

		</div>
	</nav>

	<div id="map">
		<!--Move buttons + Info boxes here.-->
	</div>
	<div class="map-control-widget">
		<button id="btn-heatmap"class=button1 onclick="myFunctionz('Heatinfo')">Heatmap</button>
	  <button id="btn-markers"class=button1 onclick="myFunctionz('Markersinfo')">Markers</button>
	  <button id="btn-data"class=button1 onclick="myFunctionz('geoinfo')">GeoJSON</button>
	</div>
	<div id="Heatinfo">
	This layer displays a heatmap of pollution removed in the form of carbon absorbed or carbon stored due to trees.
	</div>
	<div id="Markersinfo">
	This layer displays indvidual trees. Click on each marker for more information like tree height or type.
	</div>
	<div id="geoinfo">
	This is my DIV element3.
	</div>

	<!-- Javascript from external sources (Google, jQuery, etc.) gets loaded here -->
	<script type='text/javascript' src='http://code.jquery.com/jquery-1.10.2.min.js?ver=1.10.2'></script>
	<script type="text/javascript"
		src="https://maps.googleapis.com/maps/api/js?libraries=visualization&key=AIzaSyCK_2YHUeL00WeSl7OSZCKATaHIH7cxKG4"></script>
	<!-- XDate For Date formatting-->
	<script type='text/javascript' src='http://dev.spatialdatacapture.org/xdate/xdate.js'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
		crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
		integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
		crossorigin="anonymous"></script>
	<script type="text/javascript" <script type='text/javascript'
		src='https://opendata.camden.gov.uk/resource/csqp-kdss.json?$$app_token=5YbHlvnsIgblrrY3kSuIU9WZ0'></script>
	<script type='text/javascript' src='./js/JS.js'></script>
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script type='text/javascript' src='./JS/HC.js'></script>

	<!-- High Charts-->
	<div id="container" style="min-width: 310px; max-width: 70%; height: 1000px; margin: 0 auto ; padding-top: 20px" >

		<script type="text/javascript">

			$(function () {
				$('#container').highcharts({
					chart: {
						type: 'bar'
					},
					colors: ['#797D62', '#9B9B7A', '#D9AE94', '#F1DCA7', 'D08C60', 'ae9e90'],
					title: {
						text: 'Tree Types'
					},
					xAxis: {
						categories: [" Belsize ",
							" Bloomsbury ",
							" Camden Town with Primrose Hill ",
							" Cantelowes ",
							" Fortune Green ",
							" Frognal and Fitzjohns ",
							" Gospel Oak ",
							" Hampstead Town ",
							" Haverstock ",
							" Highgate ",
							" Holborn and Covent Garden ",
							" Kentish Town ",
							" Kilburn ",
							" King's Cross ",
							" Regent's Park ",
							" St Pancras and Somers Town ",
							" Swiss Cottage ",
							" West Hampstead ",]
					},
					yAxis: {
						min: 0,
						title: {
							text: 'Trees by Height'
						}
					},
					legend: {
						reversed: true
					},
					plotOptions: {
						series: {
							stacking: 'normal'
						}
					},
					series: [{
						name: '0-10',
						data: [310, 476, 576, 666, 778, 580, 856, 698, 721, 1314, 556, 1045, 773, 386, 449, 922, 463, 550, 148]
					}, {
						name: '10-20',
						data: [309, 248, 295, 478, 455, 562, 500, 572, 602, 1071, 385, 390, 681, 319, 390, 642, 415, 278, 48]
					}, {
						name: '20-30',
						data: [56, 240, 51, 81, 37, 150, 125, 59, 95, 280, 340, 34, 79, 83, 124, 214, 100, 9, 9]
					}, {
						name: '30-40',
						data: [2, 42, 0, 1, 0, 0, 0, 1, 0, 4, 8, 0, 1, 30, 15, 8, 1, 0, 0]
					}
						, {
						name: '40+',
						data: [1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
					}

					]
				});
			});
		</script>
	</div>

	<!-- Google Map JS gets loaded below here! -->
	<script type="text/javascript">

		var map;       			//	Declare empty variables for use later.
		var markerArray = [];
		var dataArray 	= [];
		var heatArray	= [];
		var heatmap 		;
		var dataMap			;
		var count			;
		var dCount 		= 0	;
		var coeffMin 	= Number.MAX_VALUE;
		var coeffMax 	= Number.MIN_VALUE;
		var infowindow 	= new google.maps.InfoWindow({ maxWidth: 300 });

		//jQuery initialises and runs after body loads.
		$(document).ready(function() {

			// Initialize map.
			function initialise() {
				// The location of Camden.
				var camden_cds = { lat: 51.554756, lng: -0.164345 };
				// Map Options
				var mapOptions = {
					center: camden_cds,
					zoom: 14,
					minZoom: 12,
					styles: retroMap,
					disableDefaultUI: true,
					zoomControl: true
				};
				// The map, centered at camden
				map = new google.maps.Map(document.getElementById('map'), mapOptions);
				
				//	Init geoJSON retrieval for data layer
				dataMap = new google.maps.Data();
				dataMap.loadGeoJson('http://dev.spatialdatacapture.org:8703/data/boundary', {idPropertyName : 'name'});
				
				//	Init heatmap.
				heatmap = new google.maps.visualization.HeatmapLayer({
					data: getHeatmap()
				});
				
				//  Gets Data on map load.
				getData(map.getCenter().lat(), map.getCenter().lng());
				//  The marker, positioned at camden
				//var marker = new google.maps.Marker({ position: camden_cds, map: map });
			}

			//    Create function that gets the tree data to be shown on map from API.
			function getData(lat, lng) {
				var lat = lat.toFixed(2); //Changes to 2 decimal places.
				var lng = lng.toFixed(3);

				console.log("Getting Data: " + lat + ", " + lng);

				setAllMap(null);
				markerArray = [];
				var radius = 2000; //Radius of 2km.

				//  URL = API Endpoint that gets the data. Check "http://dev.spatialdatacapture.org:8703/" for more info.
				var url = "http://dev.spatialdatacapture.org:8703/data/" + lat + "/" + lng + "/" + radius;
				console.log("API Endpoint :" + url);

				//  jQuery gets data through API Endpoint
				$.getJSON(url, function (data) {
					//  Declare variables
					var latitude;
					var longitude;
					console.log("Declared latitude,longitude variables.");
					//Loops through each row, extracts coordinates, and generates marker on map.
					$.each(data, function (key, value) {
						latitude = value["Lat"];
						longitude = value["Lon"];
						console.log("lat: " + latitude + ", lon: " + longitude);

						var latlng = new google.maps.LatLng(latitude, longitude);



						dataArray.push(latlng);
						//Make new marker on map.
						var marker = new google.maps.Marker({
							position: latlng,
							customInfo: value.id,
							icon: "./img/icon.png",
							map: map
						});

						//When you click on tree display some information from API Endpoint.
						google.maps.event.addListener(marker, 'click', function (content) {
							return function () {
								infowindow.setContent("");

								map.setCenter(new google.maps.LatLng(value.coords.y, value.coords.x)); //Moves map to marker center.
								$.getJSON("http://dev.spatialdatacapture.org:8703/data/treeDescription/" + this.customInfo, function (data) { //Adds custom info to marker based on API Endpoint.
									var dateInspected = new XDate((data[0].Date)).toString("MMM d, yyyy HH:mm:ss");
									var dateUploaded = new XDate((data[0].Uploaded)).toString("MMM d, yyyy HH:mm:ss");
									var content = "<b> Tree ID: </b>" + value.id + "<br/> <br/><b> Common Name:</b>" + data[0].Com_Name +
										" <br/> <br/><b>Height (m): </b>" + data[0].Height_M + " <br/> <br/><b>Spread (m): </b>" + data[0].Spread_M +
										"<br/> <br/><b> Diameter (cm): </b>" + data[0].Diameter_CM + " <br/> <br/><b>Maturity: </b>" + data[0].Maturity +
										"<br/> <br/><b> Health: </b>" + data[0].Condition + "<br/> <br><b> Location: </b>" + value.coords.y + ", " + value.coords.x +
										"<br/> <br><b> Date Inspected: </b>" + dateInspected + "<br/> <br><b> Date Uploaded: </b>" + dateUploaded;

									infowindow.setContent(content)
								})

								infowindow.open(map, this);
							}
						}(""));

						markerArray.push(marker);

					});
					console.log(markerArray.length);
					count = 0;
				});

			}
			//Heatmap function, gets data for heatmap.
			function getHeatmap() {
				//Need to add input that depends on user button press.
				//Store input variable.
				var wgt = "Carbon_Sequest_YR";
				console.log("Getting weighted location data: " + wgt);

				//setAllMap(null);  //Clears map of markers.
				heatArray = [];   //Clears heatmap data array.

				//    URL = API ENDPOINT to get spatial weighted data. Check "http://dev.spatialdatacapture.org:8703/" for more.
				var url = "http://dev.spatialdatacapture.org:8703/data/sust/" + wgt;
				console.log("API Endpoint: " + url);

				//    jQuery to grab data through endpoint
				$.getJSON(url, function (data) {
					var latitude;
					var longitude;
					var weight;
					$.each(data, function (key, value) {
						latitude = value["Lat"];
						longitude = value["Lon"];
						weight = value[wgt];
						console.log("lat:" + latitude + ", lon: " + longitude + ", " + wgt + ": " + weight);

						var loc = new google.maps.LatLng(latitude, longitude);
						var object = { location: loc, weight: weight };
						heatArray.push(object);
					})
					console.log("heatmap array length: " + heatArray.length);
				})
				return heatArray;
			}

			//	Functions for GeoJSON.
			function clusterData(measure){
				//Something about measure.

				//	URL = API Endpoint to get JSON data for wards on data layer.
				var url = "http://dev.spatialdatacapture.org:8703/data/clusters";
				console.log("API Endpoint: " + url);

				//	jQuery to grab data through endpoint.
				$.getJSON(url, function(data){
					var ward_name;
					var result;
					//	Loops through each row of the retrieved JSON.
					$.each(data, function (key, value){
						ward_name 	= value["ward_name"];
						//	coeff = the clustering coefficient value assigned to that ward.
						coeff 		= parseFloat(value[measure]);
						console.log("Ward: " + ward_name + ", Value: " + coeff);
						//	Get feature/ward of GeoJSON by ward_name and assign to variable.
						var feat = dataMap.getFeatureById(ward_name)
						if (feat != undefined) {
							console.log("Feature exists!");
							feat.setProperty('data', coeff);	//	Set property of ward to be value.
							console.log("Property set");
							console.log(feat);
						}
						//	Tracking min and max values of coeff for legend.
						if (coeff < coeffMin){
							coeffMin = coeff;
							console.log("New Min: " + coeffMin);
						}
						if (coeff > coeffMax){
							coeffMax = coeff;
							console.log("New Max: " + coeffMax);
						}
					});
					console.log("coeff Min: " + coeffMin + ", coeff Max: " + coeffMax);
					//	Add min-max update legend (getElementById . . .)
					
				});
			}

			function styleFeature(feature) {
				var low 	= 	[210,91,22]; //Colours of min and max datum in hsl.
				var high 	=	[360,97,60];

				//	Delta represents ratio of where the data value sits between min and max.
				var delta = (feature.getProperty('data') - coeffMin) / (coeffMax - coeffMin);
				console.log("delta: " + delta);
				console.log("data: " + feature.getProperty('data'));

				//	Assign colour to feature using math :P.
				var colour = [];
				for ( var i = 0; i < 3; i++ ) {
					colour[i] = (high[i] - low[i]) * delta + low[i];
				}

				//	Determine whether to show this feature style or not.
				var showRow = true;
				if ( feature.getProperty('data') == null  || isNaN(feature.getProperty('data'))) {
					showRow = false;
				}
				console.log("show: " + showRow);

				//	Declare line weights/z index and amplify when mouseover.
				var outlineWeight = 2, zIndex = 1;
				if ( feature.getProperty('state') === 'hover') {
					outlineWeight 	= 4;
					zIndex 			= 2;					
				}
				
				return {
					strokeWeight: outlineWeight,
					strokeColor: '#ebe5d5',
					zIndex: zIndex,
					fillColor: 'hsl(' + colour[0] + ',' + colour[1] + '%,' + colour[2] + '%)', 
					fillOpacity: 0.75,
					visible: showRow
				};
			}

			function mouseInWard(e) {
				//	Set hover state so that styleFeature func can change border styles.
				e.feature.setProperty('state', 'hover');

				//	Add percent calculator and update the legend.
			}

			function mouseOutWard(e) {
				//	Reset hover state.
				e.feature.setProperty('state', 'normal');
			}

			//	Loads the ward boundary polygon from geoJSON source.
			//	Functions for Map toggles.
			function toggleMarkers(){
				heatmap.setMap(null);
				dataMap.setMap(null);
				dCount = 0;
				if(count == 0){
					clearMarkers();
					count = 1;
				}else{
					setAllMap(map);
					count = 0;
				}
			}

			function toggleHeatmap() {
				console.log("Clearing Map...")
				clearMarkers();
				count = 1;
				dataMap.setMap(null);
				dCount = 0;
				console.log("Starting Heatmap...")
				heatmap.setMap(heatmap.getMap() ? null : map);
			}

			function toggleData() {
				console.log("Clearing Map...")
				clearMarkers();
				count = 1;
				heatmap.setMap(null);
				console.log("Grabbing Polygons...")
				if (dCount == 0){
					console.log(dataMap.getFeatureById('Belsize'));
					clusterData('Amenity_Gi')
					//dataMap.setMap(map);
					console.log(dataMap.getFeatureById('Belsize'));
					dataMap.setStyle(styleFeature);
					dataMap.addListener('mouseover', mouseInWard);
					dataMap.addListener('mouseout', mouseOutWard);
					
					dataMap.setMap(map);
					dCount = 1;
				}	else	{
					dataMap.setMap(null);
					dCount = 0;
				}
			}

			function iterFeature(){
				dataMap.forEach(function(feature){
  						console.log("Id from Google's feature: " + feature.getId());
						var testX = feature.getId();
						console.log(dataMap.getFeatureById(testX));
						console.log(typeof(testX));
  					});
			}

			//	Button-jQuery
			$("#btn-heatmap").click(toggleHeatmap);

			$("#btn-markers").click(toggleMarkers);

			$("#btn-data").click(toggleData);

			//	Start map with initialise function, loads map with markers.
			google.maps.event.addDomListener(window, 'load', initialise);
		});

		// Functions that are used by map toggles.
		function createMarkers() {
			var marker = new google.maps.Marker({
				position: latlng
			});
		}

		function setAllMap(map) {
			for (var i = 0; i < markerArray.length; i++) {
				markerArray[i].setMap(map);
			}
		}

		function clearMarkers() {
			setAllMap(null);
		}


		String.prototype.replaceAll = function (str1, str2, ignore) {
			return decodeURIComponent(this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g, "\\$&"), (ignore ? "gi" : "g")), (typeof (str2) == "string") ? str2.replace(/\$/g, "$$$$") : str2));
		}

	</script>
	<script>
//script for changing text when buttons are clicked.
	function myFunctionz(bro) {
	  document.getElementById('Heatinfo').style.display = "none";
	  document.getElementById('Markersinfo').style.display = "none";
	  document.getElementById('geoinfo').style.display = "none";
	  console.log("plz give us a first");
	  var x = document.getElementById(bro);

	  if (x.style.display === "block") {
	    x.style.display = "none";
	  } else {
	    x.style.display = "block";
	  }
	};
</script>
</body>

</html>
